#+STARTUP: overview

* INSTRUCTIONS
This is your TODO list for the project, apart from milestones which are in PLAN.org.

You can ignore this file unless asked to work on a TODO item.

When asked to work on an item, work on a new branch as per the guidelines in CLAUDE.md.  First, come up with a plan, run it by me first, and when we agree on the approach, start implementing it.

When working on a TODO item, constrain yourself to the item at hand.  No fly-by refactors, etc.

The TODO item itself will contain the instructions itself.

Usual commit guidelines per this project apply as described in CLAUDE.md.

As part of the commit mark the item as DONE in this file.

Add a subsection in the item named "Notes", of anything interesting that came up during working on this item, that might be useful to keep in the archived DONE item.
* DONE Convert markdown files to org mode
Convert all *.md files in the project to .org mode, with the exception of CLAUDE.md
which is needed for convention.

** Notes
Converted README.md, PLAN.md, docs/protocol.md, docs/storage.md, docs/wiring.md.
Updated all cross-references in CLAUDE.md, Python docstrings, and test comments.
* DONE Avoid documenting obvious things
Change coding guidelines in CLAUDE.md to avoid documenting obvious things.  Say, a 3-4 line method shouldn't have extensive documentation. A sentence is fine.  No need to document each arg, etc.

Instead for small methods, just write a small sentence on what the function does, and
put some sort of attr as to what arg types are.  For example:

def _require_str(raw: dict[str, object], key: str) -> None:
    """Validate that *key* exists in *raw* and is a str."""

^^^^ no need to document each and every arg.

Actually, when method is obvious enough, the above format is good enough.

Change all code in project accordingly.

** Notes
Replaced verbose Args/Returns sections with type hints in signatures for
short/obvious methods. Kept Google-style sections on main API functions
(encode_request, decode_frame, parse_reply_payload, load_config, poll,
poll_all, run) but trimmed redundant arg docs where the signature suffices.
Updated CLAUDE.md guidelines to reflect the lighter approach.
* DONE Come up with web panel plan.
Familiarize with entire project, and suggest a few ways to visualize this data.
I'd like a web panel where we can see current readings, and also an option to view historical data.
Give me the 2-3 most useful ways of visualizing this data, and document it in docs/panel.org with clear subsections, explaining each option and what the benefits and drawbacks are in terms of style, maintainability, heavy usage of libraries, etc.

Provide a summary at the top (sub section in org mode) where you explain that the reader/system is free to ignore this entire file as it's just random musings, but do give a hint of where we're going with this project (that we'll need a visualization framework).

** Notes
Documented three options in docs/panel.org:
- A: Flask + HTMX (server-rendered, near-zero JS)
- B: Flask + Chart.js (JSON API + client-rendered charts)
- C: Grafana + SQLite plugin (full dashboarding tool)
Recommended Option B as the best balance of interactivity, simplicity,
and testability.  Option C noted but too heavy for this project.
* DONE Implement mock visualization panel
look at docs/panel.org.  i'm interested in option B, but only to see
how it would feel.  in a branch, work on a mock implementation that
reads from the db in the project (populate it with random reasonable
data for a year worth of readings).  put everything, including
dependencies, in a directory so i can start some sort of server, and
point my web browser at it, and play around with it.  write any design
and notes in this item under the Notes section.

i want to see how stuff would actually look and work.

** Notes
Implemented as Option B (Flask + Chart.js) in panel/ directory.
Self-contained: own venv, own pyproject.toml, no imports from master/.

- ~make demo-server~ generates data and starts the server in one step.
- ~make check-demo~ runs 22 tests (6 for data generation, 16 for API).
- generate_data.py creates ~3M rows (3 slaves, 30s intervals, 365 days).
- Temperature profiles: sinusoidal daily/seasonal cycles + Gaussian noise.
- Slave 3 channel 1 has 5% null rate to exercise null handling.
- Time windows relative to newest DB row, so data always appears live.
- Chart.js vendored at 4.4.7 (~206 KB), no CDN dependency.
- Dark industrial/SCADA theme: navy background, monospace font, flat panels.
* DONE Get rid of "payload" arguments in code base
Even though payload is the right terminology for method arguments, we're always talking about temperatures.
Perhaps rename this to something dealing with temperatures.  Choose something clean, short, and obvious.

This is for the method arguments.  I don't care what you do inside the code...for example tests.

** Notes
Renamed the temperature-specific function and its parameters:
- Function: ~parse_reply_payload~ -> ~parse_reply~ (C: ~tmon_parse_reply_payload~ -> ~tmon_parse_reply~)
- Parameter names (~payload~, ~payload_len~) kept as-is -- the argument is an
  opaque blob, not structured temperature data
- Left protocol-framing names (~encode_request~, ~decode_frame~, constants) unchanged
  since those describe the generic protocol, not temperature data.
* DONE Fix stale protocol.md references in C files
~slave/include/protocol.h~ (line 5) and ~slave/src/protocol.c~ (line 4) still
reference ~docs/protocol.md~ -- should be ~docs/protocol.org~ since the
markdown-to-org conversion.

** Notes
Updated both files to reference docs/protocol.org.
* TODO Poller.poll duplicates parse_reply logic
~poller.py:99-105~ manually unpacks the REPLY payload (struct.unpack loop,
PROTO_TEMP_INVALID check) instead of calling ~parse_reply()~ from
~protocol.py~.  The same logic already exists in ~parse_reply~.  Use it.
* WAITING Deduplicate _downsample between app.py and build_demo.py
~panel/app.py:237~ and ~panel/build_demo.py:31~ have identical ~_downsample~
functions.  Extract to a shared module (e.g. ~panel/util.py~) or have
~build_demo.py~ import it from ~app.py~.
* TODO Deduplicate _make_reply test helper
~master/tests/test_poller.py:16~ and ~master/tests/test_daemon.py:13~ define
identical ~_make_reply(addr, t0, t1, t2, t3)~ helpers.  Move to ~conftest.py~.
* TODO Remove unused import sys in generate_data.py
~panel/generate_data.py~ imports ~sys~ (line 20) but never uses it.
* TODO Move datetime imports to module level
~panel/app.py~ imports ~from datetime import ...~ inside two route functions
(lines 110, 179).  ~panel/build_demo.py~ does the same (lines 89, 128).
Move to the top of each file.
* TODO Trim verbose docstrings on test doubles
The "avoid documenting obvious things" cleanup (branch 012) didn't reach
test code.  These test helpers still have full Args/Returns sections on
one-line methods:
- ~master/tests/conftest.py~: FakeBus.send, .receive, .__init__
- ~master/tests/test_daemon.py~: CountingBus and MultiBus (every method)
- ~master/tests/test_poller.py~: _make_reply
- ~master/tests/test_config.py~: _write_toml
One-liner docstrings (or none) suffice for these.
* TODO Trim obvious-command documentation in org files
Several docs explain what competent readers can see from the Makefile:
- ~README.org~ lines 47-63: spells out what ~make build-master~, ~make
  build-slave~, ~make check-master~, ~make check-slave~ do.  The top-level
  ~make~ and ~make check~ lines are fine; the per-target breakdown adds
  little.
- ~panel/README.org~ "Quick start" section: ~make demo-setup~ and ~make
  demo-generate~ have inline comments that duplicate the Makefile.
  Consolidate to just ~make demo-server~ (which is the one that matters)
  and let the reader look at the Makefile for details.
Keep documentation that is non-obvious, like the API reference table in
~panel/README.org~ -- that's valuable.
* DONE Retire docs/panel.org or move to an archive
~docs/panel.org~ was an exploratory design document comparing three
visualization options.  The decision was made (Option B) and is fully
implemented.  The file is historical noise now.  Either delete it or move
it to a ~docs/archive/~ directory so ~docs/~ only contains current specs.

** Notes
Deleted the file. The design rationale is preserved in the archived TODO
items that reference it.
* DONE Duplicated CREATE TABLE SQL
The ~readings~ table schema appears in three places:
- ~master/src/tmon/storage.py~
- ~panel/generate_data.py~
- ~panel/tests/conftest.py~
Since panel deliberately avoids importing from master, this is somewhat
expected, but the generate_data.py copy could at least reference
docs/storage.org so a reader knows the schema is defined there.  Consider
adding a one-line comment in each copy pointing to the canonical schema in
~docs/storage.org~.

** Notes
- ~master/src/tmon/storage.py~ already referenced docs/storage.org in its
  module docstring, so no change needed there.
- Added ~# Schema: see docs/storage.org~ comment above _CREATE_TABLE in
  ~panel/generate_data.py~ and ~panel/tests/conftest.py~.
- Updated ~panel/generate_data.py~ docstring to reference docs/storage.org
  instead of master/src/tmon/storage.py.
