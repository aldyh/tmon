#+STARTUP: showall

* tmon: A temperature monitoring system

A small, home-use *Raspberry Pi + ESP32* setup for monitoring temperatures over *RS-485*.

** What it is

- *Master (Raspberry Pi):* Python daemon that collects readings from ESP32 slaves and stores them in SQLite.
- *Transport:* RS-485 (USB adapter, master polls) or UDP over WiFi (slaves push with deep sleep).
- *Slaves (ESP32):* Each reads up to *4 NTC thermistors*.
- *Protocol:* Simple custom binary frames with *CRC-16/MODBUS*.
- *Scale:* 1-4 slaves; designed to stay small and stable.

** Directory layout

- ~master/~ -- Python 3.11+ polling daemon
  - ~src/tmon/~ -- protocol, bus, poller, storage, config
  - ~tests/~ -- pytest unit tests (no hardware)
  - ~tools/~ -- x86 serial simulator + ~socat~ harness (integration tests)
- ~slave/~ -- ESP32 firmware (PlatformIO, Arduino framework)
- ~panel/~ -- demo dashboard (Flask + Chart.js)
- ~docs/~ -- documentation (see links below)

** Quick start

*** Prerequisites

- Python 3.11+
- [[https://platformio.org/][PlatformIO]] -- install via
  [[https://pipx.pypa.io/][pipx]] (~apt~ package is outdated on recent
  Ubuntu):

  #+begin_example
  sudo apt install pipx
  pipx install platformio
  pipx ensurepath          # if ~/.local/bin is not already on PATH
  #+end_example

*** Build

#+begin_example
make                  # create master venv + deps, build slave firmware
#+end_example

*** Test

#+begin_example
make check            # run all tests (no hardware needed)
#+end_example

*** Flash slaves

#+begin_example
make flash-slave SLAVE_ADDR=1        # RS-485 transport
make flash-slave-udp SLAVE_ADDR=1   # UDP push (WiFi with deep sleep)
#+end_example

For UDP builds, copy ~master/wifi.toml.example~ to ~master/wifi.toml~ and fill in your WiFi credentials.

*** Run the daemon

#+begin_example
make run-master       # RS-485 (uses master/config.toml)
make run-master-udp  # UDP push (uses master/config-udp.toml)
#+end_example

Runs in foreground; Ctrl+C to stop.

** Deployment

Install on a target machine (e.g. Raspberry Pi):

#+begin_example
sudo make install
#+end_example

This creates a ~tmon~ system user, installs the daemon and panel into
~/var/lib/tmon/venv/~, copies config files to ~/etc/tmon/~, and loads
systemd units.  Services are installed but *not* enabled -- choose which
to run:

#+begin_example
sudo systemctl enable --now tmond-serial   # RS-485 transport
sudo systemctl enable --now tmond-udp      # UDP push transport
sudo systemctl enable --now tmon-panel     # web dashboard on port 5000
#+end_example

To uninstall (preserves config and database by default):

#+begin_example
sudo make uninstall              # keeps /etc/tmon/ and /var/lib/tmon/
sudo deploy/uninstall.sh --purge # removes everything
#+end_example

** Documentation

- [[file:docs/protocol.org][Protocol Specification]]
- [[file:docs/wiring.org][Wiring Reference]]
- [[file:docs/storage.org][Storage Specification]]
