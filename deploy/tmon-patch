#!/usr/bin/env python3
"""tmon-patch -- patch configuration into a firmware binary.

Finds @@MARKER_XXX@@ byte patterns in the binary and overwrites each
marker array with the real value.  Numeric fields are written as raw
binary; string fields are null-terminated and null-padded.

Usage:
    tmon-patch INPUT OUTPUT --addr=N [--ssid=S] [--pass=S] [--host=S]
                                     [--port=N] [--push=N]
"""

import argparse
import struct
import sys


def find_marker(data, marker):
    """Return the offset of *marker* in *data*, or -1 if not found."""
    encoded = marker.encode("ascii")
    offset = data.find(encoded)
    if offset == -1:
        return -1
    if data.find(encoded, offset + 1) != -1:
        print(f"error: marker {marker} found more than once", file=sys.stderr)
        sys.exit(1)
    return offset


def patch_uint8(data, marker, value, array_size):
    """Patch a single uint8 value into the marker array region."""
    offset = find_marker(data, marker)
    if offset == -1:
        print(f"error: marker {marker} not found in binary", file=sys.stderr)
        sys.exit(1)
    patch = struct.pack("B", value) + b"\x00" * (array_size - 1)
    return data[:offset] + patch + data[offset + array_size:]


def patch_uint16(data, marker, value, array_size):
    """Patch a little-endian uint16 value into the marker array region."""
    offset = find_marker(data, marker)
    if offset == -1:
        print(f"error: marker {marker} not found in binary", file=sys.stderr)
        sys.exit(1)
    patch = struct.pack("<H", value) + b"\x00" * (array_size - 2)
    return data[:offset] + patch + data[offset + array_size:]


def patch_string(data, marker, value, array_size):
    """Patch a null-terminated string into the marker array region."""
    encoded = value.encode("utf-8")
    if len(encoded) >= array_size:
        print(
            f"error: value for {marker} is {len(encoded)} bytes, "
            f"max {array_size - 1}",
            file=sys.stderr,
        )
        sys.exit(1)
    offset = find_marker(data, marker)
    if offset == -1:
        print(f"error: marker {marker} not found in binary", file=sys.stderr)
        sys.exit(1)
    patch = encoded + b"\x00" * (array_size - len(encoded))
    return data[:offset] + patch + data[offset + array_size:]


def main():
    parser = argparse.ArgumentParser(
        description="Patch configuration into tmon firmware binary."
    )
    parser.add_argument("input", help="Input firmware binary")
    parser.add_argument("output", help="Output (patched) firmware binary")
    parser.add_argument("--addr", type=int, required=True,
                        help="Slave address (1-247)")
    parser.add_argument("--ssid", help="WiFi SSID (max 32 chars)")
    parser.add_argument("--pass", dest="password",
                        help="WiFi password (max 64 chars)")
    parser.add_argument("--host", help="Master hostname/IP (max 64 chars)")
    parser.add_argument("--port", type=int, help="Master UDP port (1-65535)")
    parser.add_argument("--push", type=int,
                        help="Push interval in seconds (1-65535)")

    args = parser.parse_args()

    if args.addr < 1 or args.addr > 247:
        print(f"error: --addr must be 1-247 (got {args.addr})", file=sys.stderr)
        sys.exit(1)

    if args.port is not None and (args.port < 1 or args.port > 65535):
        print(f"error: --port must be 1-65535 (got {args.port})",
              file=sys.stderr)
        sys.exit(1)

    if args.push is not None and (args.push < 1 or args.push > 65535):
        print(f"error: --push must be 1-65535 (got {args.push})",
              file=sys.stderr)
        sys.exit(1)

    with open(args.input, "rb") as f:
        data = bytearray(f.read())

    data = patch_uint8(data, "@@MARKER_ADDR@@", args.addr, 16)

    if args.ssid is not None:
        data = patch_string(data, "@@MARKER_SSID@@", args.ssid, 33)
    if args.password is not None:
        data = patch_string(data, "@@MARKER_PASS@@", args.password, 65)
    if args.host is not None:
        data = patch_string(data, "@@MARKER_HOST@@", args.host, 65)
    if args.port is not None:
        data = patch_uint16(data, "@@MARKER_PORT@@", args.port, 16)
    if args.push is not None:
        data = patch_uint16(data, "@@MARKER_PUSH@@", args.push, 16)

    with open(args.output, "wb") as f:
        f.write(data)

    patched = [f"addr={args.addr}"]
    if args.ssid is not None:
        patched.append(f"ssid={args.ssid}")
    if args.password is not None:
        patched.append("pass=***")
    if args.host is not None:
        patched.append(f"host={args.host}")
    if args.port is not None:
        patched.append(f"port={args.port}")
    if args.push is not None:
        patched.append(f"push={args.push}")
    print(f"Patched {', '.join(patched)} -> {args.output}")


if __name__ == "__main__":
    main()
