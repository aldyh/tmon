#+STARTUP: showall
* Wiring Reference

This document describes how to wire each ESP32-S3 slave node to an
RS-485 bus with up to four NTC thermistors.

** Pin assignments

| Function       | ESP32 GPIO | Notes                            |
|----------------+------------+----------------------------------|
| UART TX        | GPIO 17    | To MAX485 DI                     |
| UART RX        | GPIO 16    | From MAX485 RO                   |
| RS-485 DE/RE   | GPIO 5     | To MAX485 DE and RE (tied)       |
| NTC channel 0  | GPIO 1     | ADC1_CH0                         |
| NTC channel 1  | GPIO 2     | ADC1_CH1                         |
| NTC channel 2  | GPIO 3     | ADC1_CH2                         |
| NTC channel 3  | GPIO 4     | ADC1_CH3                         |

*Board:* esp32-s3-devkitc-1

*Why ADC1?*  ADC2 cannot be used while WiFi is active.  All
thermistor inputs are on ADC1 so WiFi remains available if needed.

** MAX485 wiring

The MAX485 is a half-duplex RS-485 transceiver.  DE and RE are tied
together so a single GPIO controls bus direction.

#+begin_example
ESP32                MAX485               RS-485 bus
-----                ------               ----------
GPIO 17 (TX) ------> DI
GPIO 16 (RX) <------ RO
GPIO  5      ------> DE + RE (tied)
                      A  ------------->  A
                      B  ------------->  B
             GND ---- GND ------------>  GND
             3.3V --- VCC
#+end_example

*Bus direction:* HIGH = transmit, LOW = receive.  Switch to receive
immediately after the last byte is transmitted.

** NTC thermistor voltage divider

Each NTC thermistor is read through a voltage divider against a
fixed 10k-ohm reference resistor.

#+begin_example
3.3V
 |
[10k fixed resistor]
 |
 +-------> GPIO 1/2/3/4 (ADC input)
 |
[NTC thermistor]
 |
GND
#+end_example

With this arrangement (fixed resistor on the high side, NTC on the
low side), the ADC voltage decreases as temperature rises (NTC
resistance drops).

*Component values:*

- NTC thermistor: 10k ohm at 25 C (standard B=3950 type).
- Reference resistor: 10k ohm, 1% tolerance.

*Optional:* a 100 nF ceramic capacitor from the ADC input to GND
can reduce noise on the reading.

** RS-485 bus wiring

All nodes (master USB adapter + ESP32 slaves) share a single
twisted pair plus ground.

#+begin_example
Pi (USB-RS485)       Slave 1         Slave 2         Slave N
   A ----+-----------+- A --+---------+- A --+-- ... --+- A
   B ----+-----------+- B --+---------+- B --+-- ... --+- B
  GND ---+-----------+- GND-+---------+- GND-+-- ... --+- GND
         |                                              |
      [120R]                                         [120R]
      (term.)                                        (term.)
#+end_example

- Use twisted pair cable for A/B.  Run a separate ground wire.
- 120-ohm termination resistors at both physical ends of the bus.
- Keep the bus under 30 meters for a home installation; this is
  well within RS-485 limits.
- At 9600 baud there is generous margin for cable length and noise.

** Raspberry Pi side

The master uses a USB-to-RS-485 adapter.  No additional wiring is
needed on the Pi beyond plugging in the adapter and connecting A, B,
GND to the bus.

The adapter typically appears as ~/dev/ttyUSB0~.

** Raspberry Pi GPIO UART (bare UART test)

For initial testing without RS-485 hardware, the ESP32 can connect
directly to the Pi's GPIO UART pins.  This requires disabling
Bluetooth (which uses the same UART) and the serial console.

*Pi configuration:*

1. Edit ~/boot/firmware/config.txt~:
   #+begin_example
   enable_uart=1
   dtoverlay=disable-bt
   #+end_example

2. Edit ~/boot/firmware/cmdline.txt~: remove ~console=serial0,115200~
   if present.

3. Reboot.  ~/dev/serial0~ is now available on GPIO 14 (TX) / GPIO 15
   (RX).

*Bare UART test wiring:*

#+begin_example
ESP32                         Raspberry Pi
-----                         ------------
GPIO 17 (TX) ----[wire]----> GPIO 15 (RX)
GPIO 16 (RX) <---[wire]----- GPIO 14 (TX)
GND          ----[wire]----- GND
GPIO 5 (DE/RE)               [toggled but not connected]
#+end_example

The ESP32 firmware still toggles GPIO 4 for DE/RE timing, but since
there is no MAX485, the signal goes nowhere.  This validates the UART
and protocol logic before adding RS-485 hardware.

*Transition to MAX485:*

Once the bare UART test passes, move the ESP32 wires from the Pi GPIO
to the MAX485 module (GPIO 17 -> DI, GPIO 16 <- RO, GPIO 5 -> DE+RE).
The Pi then uses a USB-RS485 adapter instead of the GPIO UART.

** Power
- All nodes must share a common ground via the bus GND wire.
