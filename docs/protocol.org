#+STARTUP: showall
#+OPTIONS: num:1
#+TITLE: Protocol specification

Binary protocol for temperature monitoring.

* Transport modes

** Poll mode (RS-485)

- *Bus:* RS-485 half-duplex, 9600 baud, 8N1.
- *Topology:* Single server (Raspberry Pi), 1-247 clients (ESP32).
- *Flow:* Server sends a POLL; addressed client replies with a REPLY.
  All other clients stay silent.

** Push mode (UDP)

- *Transport:* UDP over WiFi.
- *Topology:* Single server listening on a UDP port, clients push.
- *Flow:* Clients wake periodically, send a REPLY frame via UDP to
  the server, then return to deep sleep.  No POLL needed.
- *Addressing:* The ADDR byte in the REPLY identifies the client.

* Frame format

Every frame (both directions) uses the same envelope:

#+begin_example
[START] [ADDR] [CMD] [LEN] [PAYLOAD ...] [CRC_LO] [CRC_HI]
#+end_example

| Field   | Size    | Description                                           |
|---------+---------+-------------------------------------------------------|
| START   | 1 byte  | ~0x01~ (SOH) -- frame delimiter                      |
| ADDR    | 1 byte  | Client address, 1-247                                 |
| CMD     | 1 byte  | Command byte (see below)                              |
| LEN     | 1 byte  | Payload length in bytes (0-255)                       |
| PAYLOAD | 0-N     | Command-specific data                                 |
| CRC_LO  | 1 byte  | CRC-16/MODBUS, low byte                               |
| CRC_HI  | 1 byte  | CRC-16/MODBUS, high byte                              |

** CRC

CRC-16/MODBUS computed over ~ADDR + CMD + LEN + PAYLOAD~ (everything
between START and CRC).  Transmitted little-endian (low byte first).

Polynomial: 0x8005, initial value: 0xFFFF, reflected input and output.

* Commands

| Command  | Value  | Direction       | Payload             |
|----------+--------+-----------------+---------------------|
| POLL     | ~0x01~ | Server -> Client | None (LEN = 0)     |
| REPLY    | ~0x02~ | Client -> Server | 8 bytes (see below) |

** POLL (0x01)

Server requests a reading from the addressed client.  No payload.

** REPLY (0x02)

Client responds with its current temperature readings.  Fixed 8-byte
payload:

| Offset | Size     | Field   | Description                               |
|--------+----------+---------+-------------------------------------------|
| 0-1    | int16 LE | temp_0  | Channel 0 temperature                     |
| 2-3    | int16 LE | temp_1  | Channel 1 temperature                     |
| 4-5    | int16 LE | temp_2  | Channel 2 temperature                     |
| 6-7    | int16 LE | temp_3  | Channel 3 temperature                     |

- Temperatures are signed, in *tenths of a degree Celsius*
  (e.g., 235 = 23.5 C, -100 = -10.0 C).
- Invalid or unconnected channels: temp value ~0x7FFF~ (sentinel).
- int16 range covers -3276.8 to +3276.7 C -- more than sufficient.

* Timing

- After sending POLL, the server waits up to *200 ms* for a REPLY.
- No response within the timeout means the client is offline.  The
  server logs the event and moves to the next client.

* Error handling

- *CRC mismatch:* frame is silently discarded.
- *Unknown command:* client ignores the frame (no reply).
- *Unexpected length:* frame is discarded.

* Constants

For reference when implementing:

#+begin_example
PROTO_START     = 0x01
PROTO_CMD_POLL  = 0x01
PROTO_CMD_REPLY = 0x02

REPLY_PAYLOAD_LEN  = 8
TEMP_INVALID       = 0x7FFF

POLL_TIMEOUT_MS    = 200
#+end_example

* Worked examples

** Example 1: server polls client 3

Frame bytes (hex):

#+begin_example
01  03  01  00  80  50
|   |   |   |   |   |
|   |   |   |   +---+-- CRC-16/MODBUS of [03 01 00] = 0x5080, LE
|   |   |   +---------- LEN = 0 (no payload)
|   |   +-------------- CMD = 0x01 (POLL)
|   +------------------ ADDR = 3
+---------------------- START = 0x01
#+end_example

Total: 6 bytes.

** Example 2: client 3 replies, channels 0 and 1 valid

Channel 0: 23.5 C (235 = 0x00EB), channel 1: 19.8 C (198 = 0x00C6).
Channels 2 and 3 invalid (0x7FFF).

Frame bytes (hex):

#+begin_example
01  03  02  08  EB 00  C6 00  FF 7F  FF 7F  90 EB
|   |   |   |   |      |      |      |      |
|   |   |   |   |      |      |      |      +-- CRC-16/MODBUS, LE
|   |   |   |   |      |      |      +--------- temp_3 = 0x7FFF (invalid)
|   |   |   |   |      |      +---------------- temp_2 = 0x7FFF (invalid)
|   |   |   |   |      +----------------------- temp_1 = 198 (19.8 C)
|   |   |   |   +------------------------------ temp_0 = 235 (23.5 C)
|   |   |   +---------------------------------- LEN = 8
|   |   +-------------------------------------- CMD = 0x02 (REPLY)
|   +------------------------------------------ ADDR = 3
+---------------------------------------------- START = 0x01
#+end_example

Total: 14 bytes.
