#+STARTUP: showall
* Storage specification

SQLite database for persisting temperature readings collected by the
master poller.

- *Database file:* ~tmon.db~ (configurable in ~config.toml~, resolved by ~tmon.paths~).
- *Engine:* SQLite 3
- *Write pattern:* one INSERT per successful poll reply.
- *No deletes or updates* during normal operation.
- *Failed polls:* no row is inserted. Timeouts, CRC errors, and other
  failures result in timestamp gaps rather than placeholder rows. This
  is intentional -- gaps keep the data clean and are easy to detect by
  checking timestamp intervals.

** Schema

*** ~readings~ table

Stores one row per successful REPLY frame received from a slave.

The authoritative schema is embedded in [[file:../master/src/tmon/storage.py][storage.py]].

*** Column details

| Column | Type    | Description                                                                         |
|--------+---------+-------------------------------------------------------------------------------------|
| id     | INTEGER | Auto-incrementing primary key.                                                      |
| ts     | INTEGER | Unix epoch timestamp (seconds since 1970-01-01 UTC).                                |
| addr   | INTEGER | Slave address from the REPLY frame (1-247).                                         |
| temp_0 | INTEGER | Channel 0 reading in tenths of a degree Celsius, or NULL if the channel is invalid. |
| temp_1 | INTEGER | Channel 1 reading, same encoding as temp_0.                                         |
| temp_2 | INTEGER | Channel 2 reading, same encoding as temp_0.                                         |
| temp_3 | INTEGER | Channel 3 reading, same encoding as temp_0.                                         |

** Path resolution

The database path in ~config.toml~ is a bare filename (e.g. ~tmon.db~).
The daemon resolves it to an absolute path based on the config file location:

| Context    | Config location          | Database location              |
|------------+--------------------------+--------------------------------|
| Dev        | ~master/config.toml~     | ~master/data/tmon.db~          |
| Production | ~/etc/tmon/config.toml~  | ~/var/lib/tmon/tmon.db~        |

This logic lives in ~tmon.paths.resolve_db()~.  The panel uses
~tmon.paths.find_db()~ which searches ~./data/~ then ~/var/lib/tmon/~.
